<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogue de Maisons</title>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    :root {
      /* Couleurs */
      --primary-color: #4a90e2;
      --primary-dark: #357abd;
      --accent-color: #667eea;
      --text-primary: #34495e;
      --text-secondary: #7f8c8d;
      --bg-white: #ffffff;
      --bg-light: #fafafa;
      --border-radius-lg: 16px;
      --border-radius-sm: 10px;
      --spacing-lg: 16px;
      --spacing-md: 12px;
      --spacing-sm: 8px;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont,
        'Segoe UI', sans-serif;
      --font-size-base: 16px;
      --font-size-lg: 18px;
      --font-size-xl: 20px;
      --shadow-md: 0 6px 20px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 12px 30px rgba(0, 0, 0, 0.12);
      --transition-base: 0.25s ease;
    }

    /* Reset */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      line-height: 1.5;
      color: var(--text-primary);
      max-width: 480px;
      margin: 0 auto;
      background: var(--bg-light);
      padding: var(--spacing-lg);
      padding-bottom: 100px;
      min-height: 100vh;
      position: relative;
    }

    /* Grille */
    .grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: var(--spacing-lg);
      max-width: 100%;
    }

    @media (min-width: 600px) {
      .grid {
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-lg);
      }
    }

    /* Carte */
    .card {
      background: var(--bg-white);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: transform var(--transition-base),
        box-shadow var(--transition-base);
      border: none;
      position: relative;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: var(--shadow-lg);
    }

    .card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      transition: transform 0.4s ease;
      border-top-left-radius: var(--border-radius-lg);
      border-top-right-radius: var(--border-radius-lg);
    }

    .card:hover img {
      transform: scale(1.05);
    }

    .card-content {
      padding: var(--spacing-lg);
    }

    .title {
      font-size: var(--font-size-xl);
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      font-weight: 700;
    }

    .price-row {
      font-weight: 700;
      color: var(--primary-dark);
      background: #dbeafe;
      padding: var(--spacing-md);
      border-radius: var(--border-radius-sm);
      margin-bottom: var(--spacing-md);
      box-shadow: inset 0 0 5px rgba(74, 144, 226, 0.3);
    }

    .info-item,
    .duration,
    .total-revenue {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: var(--spacing-sm);
    }

    .duration {
      background: #f3f4f6;
      padding: var(--spacing-md);
      border-radius: var(--border-radius-sm);
      border-left: 4px solid #cbd5e1;
    }

    .total-revenue {
      background: #dcfce7;
      color: #166534;
      font-weight: 700;
      padding: var(--spacing-md);
      border-radius: var(--border-radius-sm);
      border-left: 4px solid #22c55e;
      margin-top: var(--spacing-md);
    }

    /* Badge */
    .status-badge {
      position: absolute;
      top: var(--spacing-md);
      right: var(--spacing-md);
      padding: 4px 10px;
      border-radius: var(--border-radius-sm);
      font-size: 12px;
      font-weight: 700;
      color: var(--bg-white);
      background: var(--primary-color);
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.4);
      text-transform: uppercase;
      z-index: 2;
    }

    /* Bouton */
    .buy-button {
      background: var(--primary-color);
      color: var(--bg-white);
      border: none;
      border-radius: var(--border-radius-sm);
      padding: var(--spacing-md);
      font-size: 14px;
      font-weight: 700;
      width: 100%;
      margin-top: var(--spacing-lg);
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(74, 144, 226, 0.35);
      transition: background-color var(--transition-base),
        transform var(--transition-base);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .buy-button:hover:not(:disabled) {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    .buy-button:disabled {
      background: #b0b0b0;
      cursor: not-allowed;
      box-shadow: none;
    }

    /* Pied de carte */
    .footer {
      padding: var(--spacing-md) var(--spacing-lg);
      background: #f3f4f6;
      border-top-left-radius: 0;
      border-top-right-radius: 0;
      border-bottom-left-radius: var(--border-radius-lg);
      border-bottom-right-radius: var(--border-radius-lg);
      font-size: 13px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #4caf50;
      color: white;
      padding: 14px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 14px;
      display: none;
      z-index: 1100;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    .notification.error {
      background-color: #f44336;
    }

    /* Navigation */
    .nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      padding: 12px 0 8px;
      box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      max-width: 480px;
      margin: 0 auto;
      border-top: 1px solid #dcdcdc;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #8e9aaf;
      text-decoration: none;
      font-size: 12px;
      padding: 8px 0;
      width: 20%;
      transition: all 0.3s ease;
      position: relative;
    }

    .nav-item i {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .nav-active {
      color: var(--accent-color);
      transform: translateY(-3px);
      font-weight: 700;
    }

    .nav-active::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 30px;
      height: 3px;
      background: var(--accent-color);
      border-radius: 0 0 10px 10px;
    }

    .nav-active i {
      background-color: rgba(102, 126, 234, 0.15);
      padding: 8px;
      border-radius: 50%;
    }
  </style>
</head>

<body>
  <div class="notification"></div>

  <div class="grid">
    <div class="card" data-house-id="1">
      <div class="status-badge">Bénéfice estimé : 6.300 FCFA</div>
      <img
        src="https://image.noelshack.com/fichiers/2025/37/1/1757317604-cash-flow-1.jpg"
        alt="Maison 1"
      />
      <div class="card-content">
        <h2 class="title">Cash flow--->Niveau 1</h2>
        <div class="price-row">
          <span>Prix : 5.700 FCFA</span>
        </div>
        <div class="info-item">
          <span>Revenus quotidienne : 1.500F</span>
        </div>
        <div class="duration">Cycle: 8 Jours </div>
        <div class="total-revenue">Révenus total : 12.000 FCFA</div>
        <button
          class="buy-button"
          onclick="investProduct(1, 5700)"
          id="btn-1"
        >
          Investir maintenant
        </button>
      </div>
      <div class="footer">
        <span>Limite d'achat: 1 par personne</span>
      </div>
    </div>

    <div class="card" data-house-id="2">
      <div class="status-badge">Bénéfice estimé : 20.200 FCFA</div>
      <img
        src="https://image.noelshack.com/fichiers/2025/37/1/1757318275-cash-flow-management-for-businesses.png"
        alt="Maison 2"
      />
      <div class="card-content">
        <h2 class="title">Cash flow--->Niveau 2</h2>
        <div class="price-row"><span>Prix :15.000F</span></div>
        <div class="info-item"><span>Revenus quotidienne: 3.200F</span></div>
        <div class="duration">Cycle 11 jours </div>
        <div class="total-revenue">Revenus total : 35.200 FCFA</div>
        <button
          class="buy-button"
          onclick="investProduct(2, 15000)"
          id="btn-2"
        >
          Investir maintenant
        </button>
      </div>
      <div class="footer">
        <span>Limite d'achat: 2 par personne</span>
      </div>
    </div>

    <div class="card" data-house-id="3">
      <div class="status-badge">Bénéfice estimé : 61.000 FCFA</div>
      <img
        src="https://image.noelshack.com/fichiers/2025/37/1/1757318816-management.png"
        alt="Maison 3"
      />
      <div class="card-content">
        <h2 class="title">Cash flow---> Niveau 3</h2>
        <div class="price-row"><span>Prix : 30.000F</span></div>
        <div class="info-item"><span>Revenus quotidienne : 7.000F</span></div>
        <div class="duration">Cycle 13 jours</div>
        <div class="total-revenue">Revenus total: 91.000 FCFA</div>
        <button
          class="buy-button"
          onclick="investProduct(3, 30000)"
          id="btn-3"
        >
          Investir maintenant
        </button>
      </div>
      <div class="footer">
        <span>Limite d'achat: 2 par personne</span>
      </div>
    </div>

    <div class="card" data-house-id="4">
      <div class="status-badge">Bénéfice estimé :150.000 FCFA</div>
      <img
        src="https://image.noelshack.com/fichiers/2025/37/1/1757325817-2023-01-microsoftteams-image-250.jpg"
        alt="Maison 4"
      />
      <div class="card-content">
        <h2 class="title">Cash flow--->Niveau 4</h2>
        <div class="price-row"><span>Prix: 60.000 FCFA</span></div>
        <div class="info-item"><span>Revenus quotidienne : 14.000 FCFA</span></div>
        <div class="duration">Cycle 15 jours</div>
        <div class="total-revenue">Revenus total: 210.000 FCFA</div>
        <button
          class="buy-button"
          onclick="investProduct(4, 60000)"
          id="btn-4"
        >
          Investir maintenant
        </button>
      </div>
      <div class="footer">
        <span>Limite d'achat: 2 par personne</span>
      </div>
    </div>

    <div class="card" data-house-id="5">
      <div class="status-badge">Bénéfice estimé: 410.000 FCFA</div>
      <img
        src="https://image.noelshack.com/fichiers/2025/37/1/1757325817-2023-01-microsoftteams-image-250.jpg"
        alt="Maison 5"
      />
      <div class="card-content">
        <h2 class="title">Cash flow---->Niveau 5</h2>
        <div class="price-row"><span>Tarif: 100 000 FCFA</span></div>
        <div class="info-item"><span>Revenus quotidienne : 25 500 FCFA</span></div>
        <div class="duration">Cycle : 20 jours</div>
        <div class="total-revenue">Revenus total: 510 000 FCFA</div>
        <button
          class="buy-button"
          onclick="investProduct(5, 100000)"
          id="btn-5"
        >
          Investir maintenant
        </button>
      </div>
      <div class="footer">
        <span>Limite d'achat: 2 par personne</span>
      </div>
    </div>

    <div class="card" data-house-id="6">
      <div class="status-badge">Bénéfice estimé :600.000 FCFA</div>
      <img
        src="https://image.noelshack.com/fichiers/2025/37/1/1757325765-images-1.png"
        alt="Maison 6"
      />
      <div class="card-content">
        <h2 class="title">Cash flow--->Niveau 6</h2>
        <div class="price-row"><span>Prix : 200 000 FCFA</span></div>
        <div class="info-item"><span>Revenus quotidienne : 50 000 FCFA</span></div>
        <div class="duration">cycle : 16 jours</div>
        <div class="total-revenue">Revenus total: 800 000 FCFA</div>
        <button
          class="buy-button"
          onclick="investProduct(6, 200000)"
          id="btn-6"
        >
          Investir maintenant
        </button>
      </div>
      <div class="footer">
        <span>Limite d'achat: 4 par personne</span>
      </div>
    </div>
  </div>

  <!-- Navigation bas -->
  <nav class="nav" role="navigation" aria-label="Menu principal">
    <a href="accueil.html" class="nav-item nav-active">
      <i class="fas fa-home" aria-hidden="true"></i>
      <span>Accueil</span>
    </a>
    <a href="investi.html" class="nav-item">
      <i class="fas fa-gem" aria-hidden="true"></i>
      <span>Marché</span>
    </a>
    <a href="machine.html" class="nav-item">
      <i class="fas fa-chart-bar" aria-hidden="true"></i>
      <span>Laboratoire</span>
    </a>
    <a href="equipe.html" class="nav-item">
      <i class="fas fa-users" aria-hidden="true"></i>
      <span>Équipe</span>
    </a>
    <a href="solde.html" class="nav-item">
      <i class="fas fa-user-circle" aria-hidden="true"></i>
      <span>Profil</span>
    </a>
  </nav>


<script type="module">
// Import des modules Firebase nécessaires
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
import {
    getDatabase,
    ref,
    get,
    set,
    onValue,
    update,
    push,
    serverTimestamp
} from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";
import { getStorage } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-storage.js";

// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDRrkHLMeb6dwgT9OnLRDnTbsAkSxO3qoQ",
    authDomain: "maison-c53c7.firebaseapp.com",
    databaseURL: "https://maison-c53c7-default-rtdb.firebaseio.com",
    projectId: "maison-c53c7",
    storageBucket: "maison-c53c7.firebaseapp.com",
    messagingSenderId: "720174612151",
    appId: "1:720174612151:web:d7af687cce1cf33dde1732"
};

// Initialisation Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Variables globales
let currentUser = null;
let userBalance = 0;
let currentSlide = 0;

// Configuration des produits
const PRODUCT_CONFIG = {
  1: {
    id: 1,
    name: "Cash flow",
    badge: "niveau 1",
    price: 5700,
    dailyRevenue: 1500,
    cycleDuration: 8,
    totalRevenue: 12000,
    purchaseLimit: 1,
    image: "https://image.noelshack.com/fichiers/2025/37/1/1757317604-cash-flow-1.jpg",
    category: "Débutant"
  },
  2: {
    id: 2,
    name: "Cash flow",
    badge: "niveau 2",
    price: 15000,
    dailyRevenue: 3200,
    cycleDuration: 11,
    totalRevenue: 35200,
    purchaseLimit: 2,
    image: "https://image.noelshack.com/fichiers/2025/37/1/1757318275-cash-flow-management-for-businesses.png",
    category: "Intermédiaire"
  },
  3: {
    id: 3,
    name: "Cash flow",
    badge: "niveau 3",
    price: 30000,
    dailyRevenue: 7000,
    cycleDuration: 13,
    totalRevenue: 91000,
    purchaseLimit: 2,
    image: "https://image.noelshack.com/fichiers/2025/37/1/1757318816-management.png",
    category: "Avancé"
  },
  4: {
    id: 4,
    name: "Cash flow",
    badge: "niveau 4",
    price: 60000,
    dailyRevenue: 14000,
    cycleDuration: 15,
    totalRevenue: 210000,
    purchaseLimit: 2,
    image: "https://image.noelshack.com/fichiers/2025/37/1/1757325817-2023-01-microsoftteams-image-250.jpg",
    category: "Professionnel"
  },
  5: {
    id: 5,
    name: "Cash flow",
    badge: "niveau 5",
    price: 100000,
    dailyRevenue: 25500,
    cycleDuration: 20,
    totalRevenue: 510000,
    purchaseLimit: 2,
    image: "https://image.noelshack.com/fichiers/2025/37/1/1757325817-2023-01-microsoftteams-image-250.jpg",
    category: "Premium"
  },
  6: {
    id: 6,
    name: "Cash flow",
    badge: "niveau 6",
    price: 200000,
    dailyRevenue: 50000,
    cycleDuration: 16,
    totalRevenue: 800000,
    purchaseLimit: 4,
    image: "https://image.noelshack.com/fichiers/2025/37/1/1757325765-images-1.png",
    category: "Elite"
  }
};

// Gestion du slider
function goToSlide(slideIndex) {
    const slides = document.querySelectorAll('.slide');
    if (!slides.length) return;

    currentSlide = slideIndex;
    slides.forEach((slide, index) => {
        slide.style.display = index === slideIndex ? 'block' : 'none';
    });
}

function nextSlide() {
    const slides = document.querySelectorAll('.slide');
    if (!slides.length) return;
    goToSlide((currentSlide + 1) % slides.length);
}

// Démarrer le défilement automatique
setInterval(nextSlide, 5000);

// Système de notification
function showNotification(message, type) {
    const notification = document.querySelector('.notification');
    if (!notification) return;

    notification.textContent = message;
    notification.style.display = 'block';
    notification.style.backgroundColor = type === 'success' ? '#4CAF50' : '#f44336';

    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Gestion des bonus de parrainage
async function processReferralBonus(amount, userId) {
    try {
        const userRef = ref(db, `users/${userId}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();

        if (!userData?.referredBy) return;

        const referrerUid = userData.referredBy;
        const bonusAmount = amount * 0.10;

        const referrerRef = ref(db, `users/${referrerUid}`);
        const referrerSnapshot = await get(referrerRef);

        if (referrerSnapshot.exists()) {
            const referrerData = referrerSnapshot.val();
            const updates = {};

            updates[`users/${referrerUid}/balance`] = (referrerData.balance || 0) + bonusAmount;
            updates[`users/${referrerUid}/totalReferralBonus`] = (referrerData.totalReferralBonus || 0) + bonusAmount;
            updates[`users/${userId}/totalBonusGenerated`] = (userData.totalBonusGenerated || 0) + bonusAmount;

            const bonusLogRef = ref(db, `bonusLogs/${referrerUid}`);
            const newBonusRef = push(bonusLogRef);
            updates[`bonusLogs/${referrerUid}/${newBonusRef.key}`] = {
                amount: bonusAmount,
                memberId: userId,
                investmentAmount: amount,
                timestamp: serverTimestamp(),
                type: 'investment_bonus'
            };

            const notificationRef = ref(db, `notifications/${referrerUid}`);
            const newNotifRef = push(notificationRef);
            updates[`notifications/${referrerUid}/${newNotifRef.key}`] = {
                type: 'referral_bonus',
                message: `Vous avez reçu un bonus de parrainage de ${bonusAmount.toLocaleString('fr-FR')} FCFA`,
                amount: bonusAmount,
                memberId: userId,
                timestamp: serverTimestamp(),
                read: false
            };

            await update(ref(db), updates);
        }
    } catch (error) {
        console.error('Erreur lors du traitement du bonus de parrainage:', error);
    }
}

// Vérification des investissements actifs
async function checkActiveInvestments(userId, productId) {
    try {
        const investmentsRef = ref(db, `investments/${userId}`);
        const snapshot = await get(investmentsRef);

        if (!snapshot.exists()) return 0;

        let activeCount = 0;
        Object.values(snapshot.val()).forEach(investment => {
            if (investment.productId === productId &&
                investment.status === 'active' &&
                investment.remainingDays > 0) {
                activeCount++;
            }
        });

        return activeCount;
    } catch (error) {
        console.error('Erreur lors de la vérification des investissements:', error);
        return 0;
    }
}

// Mise à jour des limites d'investissement
async function updateInvestmentLimits(userId) {
    try {
        for (const productId in PRODUCT_CONFIG) {
            const activeInvestments = await checkActiveInvestments(userId, Number(productId));
            const remainingPurchases = PRODUCT_CONFIG[productId].purchaseLimit - activeInvestments;
            const limitSpan = document.getElementById(`purchaseLimit${productId}`);

            if (limitSpan) {
                limitSpan.textContent = `${remainingPurchases} achat${remainingPurchases > 1 ? 's' : ''} restant${remainingPurchases > 1 ? 's' : ''}`;
            }

            const investBtn = document.querySelector(`[onclick="investProduct(${productId}, ${PRODUCT_CONFIG[productId].price})"]`);
            if (investBtn) {
                investBtn.disabled = remainingPurchases <= 0;
                if (remainingPurchases <= 0) {
                    investBtn.textContent = 'Limite atteinte';
                    investBtn.style.backgroundColor = '#999';
                }
            }
        }
    } catch (error) {
        console.error('Erreur lors de la mise à jour des limites:', error);
    }
}

// Fonction d'investissement
window.investProduct = async function(productId, amount) {
    if (!currentUser) {
        showNotification("Veuillez vous connecter pour investir", "error");
        return;
    }

    try {
        const productConfig = PRODUCT_CONFIG[productId];
        const activeInvestments = await checkActiveInvestments(currentUser.uid, productId);

        if (activeInvestments >= productConfig.purchaseLimit) {
            showNotification("Vous avez atteint la limite d'achat pour ce produit", "error");
            return;
        }

        if (userBalance < amount) {
            showNotification("Solde insuffisant pour cet investissement", "error");
            return;
        }

        const userRef = ref(db, `users/${currentUser.uid}`);
        const investmentsRef = ref(db, `investments/${currentUser.uid}`);
        const currentDate = new Date();

        const updates = {};
        updates[`users/${currentUser.uid}/balance`] = userBalance - amount;
        updates[`users/${currentUser.uid}/totalInvestments`] = serverTimestamp();

        const newInvestmentRef = push(investmentsRef);
        updates[`investments/${currentUser.uid}/${newInvestmentRef.key}`] = {
            productId: productId,
            amount: amount,
            startDate: currentDate.toISOString(),
            endDate: new Date(currentDate.getTime() + (productConfig.cycleDuration * 24 * 60 * 60 * 1000)).toISOString(),
            status: 'active',
            remainingDays: productConfig.cycleDuration,
            dailyRevenue: productConfig.dailyRevenue,
            totalRevenue: productConfig.totalRevenue,
            collectedRevenue: 0,
            lastCollection: currentDate.toISOString(),
            timestamp: serverTimestamp()
        };

        await update(ref(db), updates);
        await processReferralBonus(amount, currentUser.uid);

        userBalance -= amount;
        await updateInvestmentLimits(currentUser.uid);
        showNotification("Investissement réussi!", "success");

        setTimeout(() => {
            window.location.href = 'machine.html';
        }, 2000);
    } catch (error) {
        console.error("Erreur lors de l'investissement:", error);
        showNotification("Une erreur est survenue lors de l'investissement", "error");
    }
};

// Traitement des revenus d'investissement
async function processInvestmentRevenues() {
    if (!currentUser) return;

    try {
        const investmentsRef = ref(db, `investments/${currentUser.uid}`);
        const userRef = ref(db, `users/${currentUser.uid}`);
        const snapshot = await get(investmentsRef);

        if (!snapshot.exists()) return;

        const currentDate = new Date();
        let totalRevenue = 0;
        const updates = {};

        for (const [investmentId, investment] of Object.entries(snapshot.val())) {
            if (investment.status !== 'active' || investment.remainingDays <= 0) continue;

            const lastCollection = new Date(investment.lastCollection);
            const daysSinceLastCollection = Math.floor((currentDate - lastCollection) / (24 * 60 * 60 * 1000));

            if (daysSinceLastCollection > 0) {
                const daysToProcess = Math.min(daysSinceLastCollection, investment.remainingDays);
                const newRevenue = daysToProcess * investment.dailyRevenue;

                totalRevenue += newRevenue;
                const newRemainingDays = investment.remainingDays - daysToProcess;

                updates[`investments/${currentUser.uid}/${investmentId}/remainingDays`] = newRemainingDays;
                updates[`investments/${currentUser.uid}/${investmentId}/lastCollection`] = currentDate.toISOString();
                updates[`investments/${currentUser.uid}/${investmentId}/collectedRevenue`] =
                    (investment.collectedRevenue || 0) + newRevenue;

                if (newRemainingDays <= 0) {
                    updates[`investments/${currentUser.uid}/${investmentId}/status`] = 'completed';
                }
            }
        }

        if (totalRevenue > 0) {
            const userSnapshot = await get(userRef);
            const currentBalance = userSnapshot.val().balance || 0;
            updates[`users/${currentUser.uid}/balance`] = currentBalance + totalRevenue;

            await update(ref(db), updates);
            userBalance = currentBalance + totalRevenue;
        }
    } catch (error) {
        console.error('Erreur lors du traitement des revenus:', error);
    }
}

// Gestion de l'état de l'authentification
onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        try {
            const userRef = ref(db, `users/${user.uid}`);
            const snapshot = await get(userRef);

            if (snapshot.exists()) {
                userBalance = snapshot.val().balance || 0;
                await updateInvestmentLimits(user.uid);
                await processInvestmentRevenues();
            } else {
                showNotification("Erreur lors du chargement du solde", "error");
            }
        } catch (error) {
            console.error('Erreur lors du chargement des données utilisateur:', error);
            showNotification("Erreur lors du chargement des données", "error");
        }
    } else {
        window.location.href = 'login.html';
    }
});

// Gestion des erreurs globales
window.addEventListener('error', (error) => {
    console.error('Une erreur est survenue:', error);
    showNotification('Une erreur inattendue est survenue', 'error');
});

// Fonction de déconnexion
window.handleLogout = async function() {
    try {
        await auth.signOut();
        window.location.href = 'login.html';
    } catch (error) {
        console.error('Erreur lors de la déconnexion:', error);
        showNotification('Erreur lors de la déconnexion', 'error');
    }
};
</script> 
</body>
</html>